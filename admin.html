<script>

/* ================= INIT ================= */

const storage = firebase.storage();
let allData = [];
let currentAdmin = "";


/* ================= ACTIVITY LOG ================= */

function logActivity(action){

db.collection("admin_logs").add({
admin: currentAdmin,
action: action,
time: new Date()
});

}


/* ================= AUTH CHECK ================= */

auth.onAuthStateChanged(async user=>{

if(!user){
window.location="login.html";
return;
}

currentAdmin = user.email;
adminName.innerText = user.email;


/* ADMIN CHECK (SAFE MODE) */

try{

let snap = await db.collection("admins").doc(user.uid).get();

if(!snap.exists){

alert("Admin Access Not Found ❌\nContact Developer");

auth.signOut();
window.location="login.html";
return;

}

loadProperties();
loadLeads();
loadStats();
logActivity("Login");

}catch(err){

alert("Auth Error: "+err.message);

}

});


/* ================= SAVE PROPERTY ================= */

async function saveProperty(){

try{

if(!title.value || !price.value || !location.value || !desc.value){
alert("Fill All Fields");
return;
}


/* IMAGE FILE */

let file = document.getElementById("imageFile")?.files[0];
let imageURL = "";


/* UPLOAD */

if(file){

msg.innerText="Uploading Image...";

let ref = storage.ref("properties/"+Date.now()+"_"+file.name);

await ref.put(file);

imageURL = await ref.getDownloadURL();

}else{

alert("Please Upload Image");
return;

}


/* DATA */

let data = {

title_hi: title.value,
title_en: title.value,

price_hi: price.value,
price_en: price.value,

location_hi: location.value,
location_en: location.value,

image: imageURL,

description_hi: desc.value,
description_en: desc.value,

status: "Available",

createdAt: new Date()

};


/* SAVE */

if(pid.value){

await db.collection("properties")
.doc(pid.value)
.update(data);

msg.innerText="Updated Successfully ✅";
logActivity("Updated Property");

}else{

await db.collection("properties")
.add(data);

msg.innerText="Added Successfully ✅";
logActivity("Added Property");

}

clearForm();

}catch(err){

alert("Save Error: "+err.message);

}

}


/* ================= CLEAR FORM ================= */

function clearForm(){

pid.value="";
title.value="";
price.value="";
location.value="";
desc.value="";
if(imageFile) imageFile.value="";

}


/* ================= LOAD PROPERTIES ================= */

function loadProperties(){

db.collection("properties")
.orderBy("createdAt","desc")
.onSnapshot(snapshot=>{

let html="";
allData=[];
let count=0;

snapshot.forEach(doc=>{

let d=doc.data();
d.id=doc.id;

allData.push(d);
count++;

html+=makeCard(d);

});

propertyList.innerHTML=html;
totalProp.innerText=count;

});

}


/* ================= CARD ================= */

function makeCard(d){

return `

<div class="property-box">

<h3>${d.title_hi}</h3>

<p><b>Status:</b> ${d.status}</p>
<p><b>Price:</b> ${d.price_hi}</p>
<p><b>Location:</b> ${d.location_hi}</p>

<img src="${d.image}" loading="lazy">

<p>${d.description_hi}</p>

<div class="action-btns">

<button class="edit-btn" onclick="editProperty('${d.id}')">Edit</button>

<button class="edit-btn" onclick="changeStatus('${d.id}','Sold')">Sold</button>

<button class="del-btn" onclick="deleteProperty('${d.id}')">Delete</button>

</div>

</div>

`;

}


/* ================= EDIT ================= */

function editProperty(id){

db.collection("properties")
.doc(id)
.get()
.then(doc=>{

let d=doc.data();

pid.value=id;

title.value=d.title_hi;
price.value=d.price_hi;
location.value=d.location_hi;
desc.value=d.description_hi;

window.scrollTo(0,0);

});

}


/* ================= STATUS ================= */

function changeStatus(id,status){

db.collection("properties")
.doc(id)
.update({status:status});

logActivity("Status Changed");

loadStats();

}


/* ================= DELETE ================= */

function deleteProperty(id){

if(confirm("Delete permanently?")){

db.collection("properties")
.doc(id)
.delete();

logActivity("Deleted Property");

}

}


/* ================= SEARCH ================= */

function searchProperty(){

let q = searchBox.value.toLowerCase();
let html="";

allData.forEach(d=>{

if(d.title_hi.toLowerCase().includes(q)){
html+=makeCard(d);
}

});

propertyList.innerHTML=html;

}


/* ================= LEADS ================= */

function loadLeads(){

db.collection("leads")
.orderBy("time","desc")
.onSnapshot(snapshot=>{

let html="";

snapshot.forEach(doc=>{

let d=doc.data();

html+=`

<div class="property-box">

<p><b>Name:</b> ${d.name}</p>
<p><b>Mobile:</b> ${d.mobile}</p>
<p><b>Message:</b> ${d.message}</p>

<a href="https://wa.me/91${d.mobile}" 
class="edit-btn" target="_blank">Reply</a>

</div>

`;

});

if(document.getElementById("leadList")){
leadList.innerHTML=html;
}

});

}


/* ================= STATS ================= */

function loadStats(){

db.collection("properties").get().then(snap=>{

let sold=0;
let avail=0;

snap.forEach(d=>{

if(d.data().status==="Sold") sold++;
else avail++;

});

soldCount.innerText=sold;
availCount.innerText=avail;

});

}


/* ================= BACKUP ================= */

function backupData(){

db.collection("properties").get().then(snap=>{

let data=[];

snap.forEach(d=>{
data.push(d.data());
});

let blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});

let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="backup.json";
a.click();

});

}


/* ================= LOGOUT ================= */

function logout(){

logActivity("Logout");

auth.signOut().then(()=>{
window.location="login.html";
});

}

</script>
