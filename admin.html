<script>

/* ================= INIT ================= */

const storage = firebase.storage();
let allData = [];

/* ================= AUTH CHECK ================= */

auth.onAuthStateChanged(user=>{

if(!user){
window.location="login.html";
return;
}

adminName.innerText = user.email;

/* Admin Role Check */

db.collection("admins")
.doc(user.uid)
.get()
.then(doc=>{

if(!doc.exists){
alert("Not Authorized ❌");
auth.signOut();
window.location="login.html";
}else{
loadProperties();
loadLeads();
}

});

});


/* ================= SAVE PROPERTY (WITH IMAGE UPLOAD) ================= */

async function saveProperty(){

if(
!title.value ||
!price.value ||
!location.value ||
!desc.value
){
alert("Fill All Fields");
return;
}

let file = document.getElementById("imageFile")?.files[0];
let imageURL = image?.value || "";

if(file){

msg.innerText="Uploading Image...";

let ref = storage.ref("properties/"+Date.now()+"_"+file.name);
await ref.put(file);
imageURL = await ref.getDownloadURL();

}

if(!imageURL){
alert("Add Image or Upload One");
return;
}

let data = {

title_hi: title.value,
title_en: title.value,

price_hi: price.value,
price_en: price.value,

location_hi: location.value,
location_en: location.value,

image: imageURL,

description_hi: desc.value,
description_en: desc.value,

status: "Available",

createdAt: new Date()

};

if(pid.value){

await db.collection("properties")
.doc(pid.value)
.update(data);

msg.innerText="Updated Successfully ✅";

}else{

await db.collection("properties")
.add(data);

msg.innerText="Added Successfully ✅";

}

clearForm();

}


/* ================= CLEAR FORM ================= */

function clearForm(){

pid.value="";
title.value="";
price.value="";
location.value="";
desc.value="";
if(imageFile) imageFile.value="";

}


/* ================= LOAD PROPERTIES ================= */

function loadProperties(){

db.collection("properties")
.orderBy("createdAt","desc")
.onSnapshot(snapshot=>{

let html="";
allData=[];
let count=0;

snapshot.forEach(doc=>{

let d=doc.data();
d.id=doc.id;

allData.push(d);
count++;

html+=makeCard(d);

});

propertyList.innerHTML=html;
totalProp.innerText=count;

});

}


/* ================= PROPERTY CARD ================= */

function makeCard(d){

return `

<div class="property-box">

<h3>${d.title_hi}</h3>

<p><b>Status:</b> ${d.status}</p>
<p><b>Price:</b> ${d.price_hi}</p>
<p><b>Location:</b> ${d.location_hi}</p>

<img src="${d.image}" loading="lazy">

<p>${d.description_hi}</p>

<div class="action-btns">

<button class="edit-btn" onclick="editProperty('${d.id}')">
Edit
</button>

<button class="edit-btn" onclick="changeStatus('${d.id}','Sold')">
Mark Sold
</button>

<button class="del-btn" onclick="deleteProperty('${d.id}')">
Delete
</button>

</div>

</div>

`;

}


/* ================= EDIT ================= */

function editProperty(id){

db.collection("properties")
.doc(id)
.get()
.then(doc=>{

let d=doc.data();

pid.value=id;

title.value=d.title_hi;
price.value=d.price_hi;
location.value=d.location_hi;
desc.value=d.description_hi;

window.scrollTo(0,0);

});

}


/* ================= STATUS ================= */

function changeStatus(id,status){

db.collection("properties")
.doc(id)
.update({status:status});

}


/* ================= DELETE ================= */

function deleteProperty(id){

if(confirm("Delete permanently?")){

db.collection("properties")
.doc(id)
.delete();

}

}


/* ================= SEARCH ================= */

function searchProperty(){

let q = searchBox.value.toLowerCase();
let html="";

allData.forEach(d=>{

if(d.title_hi.toLowerCase().includes(q)){
html+=makeCard(d);
}

});

propertyList.innerHTML=html;

}


/* ================= LOAD LEADS ================= */

function loadLeads(){

db.collection("leads")
.orderBy("time","desc")
.onSnapshot(snapshot=>{

let html="";

snapshot.forEach(doc=>{

let d=doc.data();

html+=`

<div class="property-box">

<p><b>Name:</b> ${d.name}</p>
<p><b>Mobile:</b> ${d.mobile}</p>
<p><b>Message:</b> ${d.message}</p>

<a href="https://wa.me/91${d.mobile}" 
class="edit-btn" target="_blank">Reply</a>

</div>

`;

});

if(document.getElementById("leadList")){
document.getElementById("leadList").innerHTML=html;
}

});

}


/* ================= LOGOUT ================= */

function logout(){

auth.signOut().then(()=>{
window.location="login.html";
});

}

</script>
