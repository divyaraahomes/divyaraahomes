<script>

/* ================= CONFIG ================= */

const storage = firebase.storage();
const auth = firebase.auth();
const db = firebase.firestore();

let allData = [];
let currentAdmin = "";
let loginTime = Date.now();


/* ================= SAFE HELPER ================= */

function el(id){
  return document.getElementById(id);
}


/* ================= AUTO LOGOUT (30 min) ================= */

setInterval(()=>{
  if(Date.now() - loginTime > 30*60*1000){
    alert("Session Expired. Login Again.");
    logout();
  }
},60000);


/* ================= ACTIVITY LOG ================= */

function logActivity(action){

  db.collection("admin_logs").add({
    admin: currentAdmin,
    action: action,
    ip: "client",
    time: new Date()
  });

}


/* ================= AUTH CHECK ================= */

auth.onAuthStateChanged(async user=>{

  if(!user){
    window.location="login.html";
    return;
  }

  currentAdmin = user.email;
  loginTime = Date.now();

  if(el("adminName")){
    el("adminName").innerText = user.email;
  }

  try{

    let snap = await db.collection("admins")
                      .doc(user.uid)
                      .get();

    if(!snap.exists){

      alert("Unauthorized Access ❌");
      await auth.signOut();
      window.location="login.html";
      return;

    }

    logActivity("Login Success");

    loadProperties();
    loadLeads();
    loadStats();

  }catch(err){

    alert("Security Error: "+err.message);

  }

});


/* ================= SAVE PROPERTY ================= */

async function saveProperty(){

try{

  if(
    !el("title").value ||
    !el("price").value ||
    !el("location").value ||
    !el("desc").value
  ){
    alert("Fill All Fields");
    return;
  }

  let file = el("imageFile")?.files[0];

  if(!file){
    alert("Upload Image First");
    return;
  }


  el("msg").innerText="Uploading...";

  /* Upload */

  let ref = storage.ref("properties/"+Date.now()+"_"+file.name);

  await ref.put(file);

  let imageURL = await ref.getDownloadURL();


  /* Data */

  let data = {

    title_hi: el("title").value,
    title_en: el("title").value,

    price_hi: el("price").value,
    price_en: el("price").value,

    location_hi: el("location").value,
    location_en: el("location").value,

    image: imageURL,

    description_hi: el("desc").value,
    description_en: el("desc").value,

    status: "Available",

    updatedBy: currentAdmin,

    createdAt: new Date()

  };


  if(el("pid").value){

    await db.collection("properties")
            .doc(el("pid").value)
            .update(data);

    el("msg").innerText="Updated ✅";

    logActivity("Update Property");

  }else{

    await db.collection("properties")
            .add(data);

    el("msg").innerText="Added ✅";

    logActivity("Add Property");

  }


  clearForm();

}catch(e){

  alert("Save Failed: "+e.message);

}

}


/* ================= CLEAR ================= */

function clearForm(){

  ["pid","title","price","location","desc","imageFile"]
  .forEach(id=>{
    if(el(id)) el(id).value="";
  });

}


/* ================= LOAD PROPERTIES ================= */

function loadProperties(){

db.collection("properties")
.orderBy("createdAt","desc")
.onSnapshot(snapshot=>{

  let html="";
  allData=[];
  let count=0;

  snapshot.forEach(doc=>{

    let d=doc.data();
    d.id=doc.id;

    allData.push(d);
    count++;

    html+=makeCard(d);

  });

  if(el("propertyList")) el("propertyList").innerHTML=html;
  if(el("totalProp")) el("totalProp").innerText=count;

});

}


/* ================= CARD ================= */

function makeCard(d){

return `

<div class="property-box">

<h3>${d.title_hi}</h3>

<p>Status: ${d.status}</p>
<p>Price: ${d.price_hi}</p>
<p>Location: ${d.location_hi}</p>

<img src="${d.image}" loading="lazy">

<p>${d.description_hi}</p>

<div class="action-btns">

<button onclick="editProperty('${d.id}')">Edit</button>

<button onclick="changeStatus('${d.id}','Sold')">Sold</button>

<button onclick="deleteProperty('${d.id}')">Delete</button>

</div>

</div>

`;

}


/* ================= EDIT ================= */

function editProperty(id){

db.collection("properties")
.doc(id)
.get()
.then(doc=>{

  let d=doc.data();

  el("pid").value=id;
  el("title").value=d.title_hi;
  el("price").value=d.price_hi;
  el("location").value=d.location_hi;
  el("desc").value=d.description_hi;

  window.scrollTo(0,0);

});

}


/* ================= STATUS ================= */

function changeStatus(id,status){

db.collection("properties")
.doc(id)
.update({status});

logActivity("Status Changed");

loadStats();

}


/* ================= DELETE ================= */

function deleteProperty(id){

if(confirm("Delete Permanently?")){

  db.collection("properties")
    .doc(id)
    .delete();

  logActivity("Deleted Property");

}

}


/* ================= SEARCH ================= */

function searchProperty(){

let q = el("searchBox").value.toLowerCase();
let html="";

allData.forEach(d=>{

  if(d.title_hi.toLowerCase().includes(q)){
    html+=makeCard(d);
  }

});

el("propertyList").innerHTML=html;

}


/* ================= LEADS ================= */

function loadLeads(){

db.collection("leads")
.orderBy("time","desc")
.onSnapshot(snapshot=>{

  let html="";

  snapshot.forEach(doc=>{

    let d=doc.data();

    html+=`

    <div class="property-box">

    <p>${d.name}</p>
    <p>${d.mobile}</p>
    <p>${d.message}</p>

    <a href="https://wa.me/91${d.mobile}" target="_blank">
    Reply
    </a>

    </div>

    `;

  });

  if(el("leadList")){
    el("leadList").innerHTML=html;
  }

});

}


/* ================= STATS ================= */

function loadStats(){

db.collection("properties")
.get()
.then(snap=>{

  let sold=0, avail=0;

  snap.forEach(d=>{

    if(d.data().status==="Sold") sold++;
    else avail++;

  });

  if(el("soldCount")) el("soldCount").innerText=sold;
  if(el("availCount")) el("availCount").innerText=avail;

});

}


/* ================= BACKUP ================= */

function backupData(){

db.collection("properties")
.get()
.then(snap=>{

  let data=[];

  snap.forEach(d=> data.push(d.data()));

  let blob=new Blob(
    [JSON.stringify(data,null,2)],
    {type:"application/json"}
  );

  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="backup.json";
  a.click();

});

}


/* ================= LOGOUT ================= */

function logout(){

logActivity("Logout");

auth.signOut().then(()=>{
  window.location="login.html";
});

}

</script>
