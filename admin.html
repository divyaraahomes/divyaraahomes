<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<title>Admin Panel | Divyaraa Homes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDdpuNucflUlnN5FZy9EV8wxgZy041mxWc",
  authDomain: "divyaraa-homes.firebaseapp.com",
  projectId: "divyaraa-homes",
  storageBucket: "divyaraa-homes.appspot.com"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
</script>

<style>

body{
margin:0;
font-family:Poppins,sans-serif;
background:#050816;
color:white;
}

header{
background:black;
color:gold;
padding:15px;
text-align:center;
font-size:20px;
}

.logout{
float:right;
background:red;
color:white;
padding:6px 12px;
border-radius:4px;
cursor:pointer;
}

.container{
max-width:1000px;
margin:auto;
padding:25px;
}

input,textarea{
width:100%;
padding:10px;
margin:6px 0;
border-radius:5px;
border:none;
}

button{
background:gold;
border:none;
padding:10px 20px;
font-weight:600;
cursor:pointer;
border-radius:5px;
}

.property-box{
background:#111;
padding:15px;
margin-top:15px;
border-radius:8px;
border:1px solid #222;
}

.property-box img{
width:100%;
max-height:200px;
object-fit:cover;
}

</style>

</head>

<body>

<header>
Admin Panel - Divyaraa Homes
<span class="logout" onclick="logout()">Logout</span>
</header>

<div class="container">

<h3 id="adminName"></h3>

<h2>Add Property</h2>

<input type="hidden" id="pid">

<input id="title" placeholder="Title">
<input id="price" placeholder="Price">
<input id="location" placeholder="Location">

<input type="file" id="imageFile">

<textarea id="desc" placeholder="Description"></textarea>

<button onclick="saveProperty()">Save</button>

<p id="msg"></p>

<hr>

<input id="searchBox" placeholder="Search..." onkeyup="searchProperty()">

<h2>All Properties (<span id="totalProp">0</span>)</h2>

<div id="propertyList"></div>

<h2>Leads</h2>

<div id="leadList"></div>

<br>

<button onclick="backupData()">Backup</button>

</div>


<script>

let allData=[];


/* AUTH */

auth.onAuthStateChanged(user=>{

if(!user){
location="login.html";
return;
}

adminName.innerText = "Logged in: " + user.email;

loadProperties();
loadLeads();

});


/* SAVE */

async function saveProperty(){

try{

if(!title.value||!price.value||!location.value||!desc.value){
alert("Fill all fields");
return;
}

let file=imageFile.files[0];

if(!file){
alert("Upload image");
return;
}

msg.innerText="Uploading...";

let ref=storage.ref("properties/"+Date.now()+"_"+file.name);

await ref.put(file);

let url=await ref.getDownloadURL();

let data={

title_hi:title.value,
price_hi:price.value,
location_hi:location.value,
image:url,
description_hi:desc.value,
status:"Available",
createdAt:new Date()

};

if(pid.value){

await db.collection("properties").doc(pid.value).update(data);
msg.innerText="Updated ✅";

}else{

await db.collection("properties").add(data);
msg.innerText="Added ✅";

}

clearForm();

}catch(e){
alert(e.message);
}

}


/* CLEAR */

function clearForm(){

pid.value="";
title.value="";
price.value="";
location.value="";
desc.value="";
imageFile.value="";

}


/* LOAD */

function loadProperties(){

db.collection("properties")
.orderBy("createdAt","desc")
.onSnapshot(snap=>{

let html="";
allData=[];
let c=0;

snap.forEach(d=>{

let x=d.data();
x.id=d.id;

allData.push(x);
c++;

html+=card(x);

});

propertyList.innerHTML=html;
totalProp.innerText=c;

});

}


/* CARD */

function card(d){

return`

<div class="property-box">

<h3>${d.title_hi}</h3>

<p>${d.price_hi}</p>
<p>${d.location_hi}</p>

<img src="${d.image}">

<p>${d.description_hi}</p>

<button onclick="edit('${d.id}')">Edit</button>

<button onclick="del('${d.id}')">Delete</button>

</div>

`;

}


/* EDIT */

function edit(id){

db.collection("properties").doc(id).get().then(d=>{

let x=d.data();

pid.value=id;
title.value=x.title_hi;
price.value=x.price_hi;
location.value=x.location_hi;
desc.value=x.description_hi;

scrollTo(0,0);

});

}


/* DELETE */

function del(id){

if(confirm("Delete?")){

db.collection("properties").doc(id).delete();

}

}


/* SEARCH */

function searchProperty(){

let q=searchBox.value.toLowerCase();
let html="";

allData.forEach(d=>{

if(d.title_hi.toLowerCase().includes(q)){
html+=card(d);
}

});

propertyList.innerHTML=html;

}


/* LEADS */

function loadLeads(){

db.collection("leads")
.orderBy("time","desc")
.onSnapshot(snap=>{

let html="";

snap.forEach(d=>{

let x=d.data();

html+=`

<div class="property-box">

<p>${x.name}</p>
<p>${x.mobile}</p>
<p>${x.message}</p>

<a target="_blank"
href="https://wa.me/91${x.mobile}">Reply</a>

</div>

`;

});

leadList.innerHTML=html;

});

}


/* BACKUP */

function backupData(){

db.collection("properties").get().then(snap=>{

let d=[];

snap.forEach(x=>d.push(x.data()));

let b=new Blob([JSON.stringify(d,null,2)]);

let a=document.createElement("a");

a.href=URL.createObjectURL(b);
a.download="backup.json";
a.click();

});

}


/* LOGOUT */

function logout(){

auth.signOut().then(()=>{
location="login.html";
});

}

</script>

</body>
</html>
