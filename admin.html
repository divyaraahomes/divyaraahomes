<script>

/* ================= INIT ================= */

const storage = firebase.storage();
let allData = [];
let currentAdmin = "";


/* ================= SAFE ELEMENT HELPER ================= */

function el(id){
return document.getElementById(id);
}


/* ================= ACTIVITY LOG ================= */

function logActivity(action){
try{
db.collection("admin_logs").add({
admin: currentAdmin,
action: action,
time: new Date()
});
}catch(e){}
}


/* ================= AUTH CHECK ================= */

auth.onAuthStateChanged(async user=>{

if(!user){
window.location="login.html";
return;
}

currentAdmin = user.email;

if(el("adminName")){
el("adminName").innerText = user.email;
}

/* ADMIN CHECK SAFE MODE */

try{

let snap = await db.collection("admins").doc(user.uid).get();

/* Agar admins collection nahi bana ho to bhi allow kare */
if(!snap.exists){
console.warn("Admin document not found, but allowing access");
}

loadProperties();
loadLeads();
loadStats();
logActivity("Login");

}catch(err){

alert("Auth Error: "+err.message);

}

});


/* ================= SAVE PROPERTY ================= */

async function saveProperty(){

try{

if(!el("title").value || !el("price").value || !el("location").value || !el("desc").value){
alert("Fill All Fields");
return;
}

let file = el("imageFile")?.files[0];
let imageURL = "";

/* Upload Image */

if(file){

if(el("msg")) el("msg").innerText="Uploading Image...";

let ref = storage.ref("properties/"+Date.now()+"_"+file.name);

await ref.put(file);

imageURL = await ref.getDownloadURL();

}else{
alert("Please Upload Image");
return;
}

/* Data */

let data = {

title_hi: el("title").value,
title_en: el("title").value,

price_hi: el("price").value,
price_en: el("price").value,

location_hi: el("location").value,
location_en: el("location").value,

image: imageURL,

description_hi: el("desc").value,
description_en: el("desc").value,

status: "Available",

createdAt: new Date()

};

/* Save */

if(el("pid").value){

await db.collection("properties")
.doc(el("pid").value)
.update(data);

if(el("msg")) el("msg").innerText="Updated Successfully ✅";
logActivity("Updated Property");

}else{

await db.collection("properties")
.add(data);

if(el("msg")) el("msg").innerText="Added Successfully ✅";
logActivity("Added Property");

}

clearForm();

}catch(err){

alert("Save Error: "+err.message);

}

}


/* ================= CLEAR FORM ================= */

function clearForm(){

if(el("pid")) el("pid").value="";
if(el("title")) el("title").value="";
if(el("price")) el("price").value="";
if(el("location")) el("location").value="";
if(el("desc")) el("desc").value="";
if(el("imageFile")) el("imageFile").value="";

}


/* ================= LOAD PROPERTIES ================= */

function loadProperties(){

db.collection("properties")
.orderBy("createdAt","desc")
.onSnapshot(snapshot=>{

let html="";
allData=[];
let count=0;

snapshot.forEach(doc=>{

let d=doc.data();
d.id=doc.id;

allData.push(d);
count++;

html+=makeCard(d);

});

if(el("propertyList")) el("propertyList").innerHTML=html;
if(el("totalProp")) el("totalProp").innerText=count;

});

}


/* ================= CARD ================= */

function makeCard(d){

return `

<div class="property-box">

<h3>${d.title_hi}</h3>

<p><b>Status:</b> ${d.status}</p>
<p><b>Price:</b> ${d.price_hi}</p>
<p><b>Location:</b> ${d.location_hi}</p>

<img src="${d.image}" loading="lazy">

<p>${d.description_hi}</p>

<div class="action-btns">

<button class="edit-btn" onclick="editProperty('${d.id}')">Edit</button>

<button class="edit-btn" onclick="changeStatus('${d.id}','Sold')">Sold</button>

<button class="del-btn" onclick="deleteProperty('${d.id}')">Delete</button>

</div>

</div>

`;

}


/* ================= EDIT ================= */

function editProperty(id){

db.collection("properties")
.doc(id)
.get()
.then(doc=>{

let d=doc.data();

el("pid").value=id;
el("title").value=d.title_hi;
el("price").value=d.price_hi;
el("location").value=d.location_hi;
el("desc").value=d.description_hi;

window.scrollTo(0,0);

});

}


/* ================= STATUS ================= */

function changeStatus(id,status){

db.collection("properties")
.doc(id)
.update({status:status});

logActivity("Status Changed");

loadStats();

}


/* ================= DELETE ================= */

function deleteProperty(id){

if(confirm("Delete permanently?")){

db.collection("properties")
.doc(id)
.delete();

logActivity("Deleted Property");

}

}


/* ================= SEARCH ================= */

function searchProperty(){

let q = el("searchBox")?.value.toLowerCase() || "";
let html="";

allData.forEach(d=>{
if(d.title_hi.toLowerCase().includes(q)){
html+=makeCard(d);
}
});

if(el("propertyList")) el("propertyList").innerHTML=html;

}


/* ================= LEADS ================= */

function loadLeads(){

db.collection("leads")
.orderBy("time","desc")
.onSnapshot(snapshot=>{

let html="";

snapshot.forEach(doc=>{

let d=doc.data();

html+=`

<div class="property-box">

<p><b>Name:</b> ${d.name}</p>
<p><b>Mobile:</b> ${d.mobile}</p>
<p><b>Message:</b> ${d.message}</p>

<a href="https://wa.me/91${d.mobile}" 
class="edit-btn" target="_blank">Reply</a>

</div>

`;

});

if(el("leadList")) el("leadList").innerHTML=html;

});

}


/* ================= STATS ================= */

function loadStats(){

db.collection("properties").get().then(snap=>{

let sold=0;
let avail=0;

snap.forEach(d=>{
if(d.data().status==="Sold") sold++;
else avail++;
});

if(el("soldCount")) el("soldCount").innerText=sold;
if(el("availCount")) el("availCount").innerText=avail;

});

}


/* ================= BACKUP ================= */

function backupData(){

db.collection("properties").get().then(snap=>{

let data=[];
snap.forEach(d=> data.push(d.data()));

let blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="backup.json";
a.click();

});

}


/* ================= LOGOUT ================= */

function logout(){

logActivity("Logout");

auth.signOut().then(()=>{
window.location="login.html";
});

}

</script>
